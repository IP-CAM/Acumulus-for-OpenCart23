Acumulus module events
=======================

@todo: This file is not up to date. Describe all 3 events.

This file documents the events that the Acumulus module defines. Currently only
1 event is defined:


acumulus.invoice.add
--------------------

Warning
-------
This event is experimental. Depending on feedback from actual usage, details
may change in future versions.

Description
-----------
The "acumulus_invoice_add" event is used to change the invoice that will be sent
to Acumulus. The Acumulus plugin has created the invoice and is about to send it
to Acumulus. But just before doing so, this event allows you to change details
of the invoice as will be sent to Acumulus.

Usage
-----
When the "acumulus_invoice_add" event is called, it is passed an array with 2
keyed items:
- 'invoice'(by reference):
  A keyed array containing the invoice that will be sent to Acumulus. The array
  structure is similar to the XML structure as defined on
  https://apidoc.sielsystems.nl/content/invoice-add, though at this stage, only
  the customer key will be present at the highest level. The line tag is
  represented as a numeric array of lines, even if if there is only 1 line.

  Some keys will be missing, if they are still missing after this event has
  been applied, they will be filled in (not overwritten) by the module before
  the actual sending takes place:
  - ['customer']['locationcode']
  - ['customer']['overwriteifexists']
  - ['customer']['type']
  - ['customer']['invoice']['concept']
  - ['customer']['invoice']['accountnumber']
  - ['customer']['invoice']['costcenter']
  - ['customer']['invoice']['template]
  - ['customer']['invoice']['vattype]

  The following keys may be filled with a null value, if the 'unitprice' of that
  'line' = 0. These null values will be replaced by the module by the most
  occurring vat rate before the actual sending takes place:
  - ['customer']['invoice']['line']['taxrate']
- 'order':
  The OpenCart order array.

Typical usages for this event allow to implement business logic specific to
your business, think of:
- Template, account number, or cost center selection based on order specifics.
- Adding descriptive info to the invoice or invoice lines based on custom order
  meta data.
- Correcting payment info based on payment modules not supported by this module.

Examples
--------
use Siel\Acumulus\Common\WebAPI;

class ControllerModuleMycustom extends Controller {

  public function install() {
    $this->load->model('tool/event');
    $this->model_tool_event->addEvent('acumulus', 'acumulus.invoice.add', 'Module/Mycustom/acumulusInvoiceAdd');
  }

  public function acumulusInvoiceAdd($args) {
    // Prevent calling directly.
    if (!isset($args['invoice']['customer')) {
      return;
    }

    $invoice = &$args['invoice'];
    $order = $args['order'];
    $is_paid = $this->determinePaymentStatus($order);
    if ($is_paid) {
      $invoice['customer']['invoice']['paymentstatus'] = WebAPI::PaymentStatus_Paid;
      $invoice['customer']['invoice']['paymentdate'] = date('Y-m-d', strtotime($someDate);
    }
    else {
      $invoice['customer']['invoice']['paymentstatus'] = WebAPI::PaymentStatus_Due;
      unset($invoice['customer']['invoice']['paymentdate']);
    }
  }
}

External Resources
------------------
- https://apidoc.sielsystems.nl/content/invoice-add.
- https://apidoc.sielsystems.nl/content/warning-error-and-status-response-section-most-api-calls
